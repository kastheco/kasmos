# Design: `kq init` -- Multi-Harness Agent Environment Setup

**Date:** 2026-02-20
**Status:** Draft

## Problem

klique orchestrates concurrent AI coding sessions across multiple agent CLIs (claude, opencode, codex), but there's no unified way to:

1. Install shared tooling (superpowers) into each CLI's expected location
2. Configure which CLI + model + tuning parameters to use per agent role
3. Scaffold project-level agent definitions and skills in each CLI's format
4. Store these preferences in a single config file that klique reads at runtime

Users currently manage this manually across `~/.claude/`, `~/.config/opencode/`, `~/.codex/`, and per-project `.claude/`, `.opencode/` directories with incompatible formats.

## Solution

A `kq init` command that runs a multi-stage interactive wizard (using charmbracelet/huh) to detect available harnesses, configure agents, and scaffold everything in one flow.

## Command Interface

```
kq init            # Interactive wizard, pre-populated from existing config
kq init --force    # Same + overwrite existing project scaffold files
kq init --clean    # Ignore existing config, start with factory defaults
kq init --clean --force  # Both
```

Re-runnable. Running again pre-fills the form from `~/.klique/config.toml` (unless `--clean`).

## Config Format

File: `~/.klique/config.toml`

```toml
# Generated by kq init

[phases]
implementing = "coder"
spec_review = "reviewer"
quality_review = "reviewer"
planning = "planner"

[agents.coder]
enabled = true
program = "opencode"
model = "anthropic/claude-sonnet-4-6"
temperature = 0.7        # omitted = harness default
effort = "high"          # omitted = harness default
flags = []

[agents.reviewer]
enabled = true
program = "claude"
model = "claude-opus-4-6"
effort = "high"
flags = ["--agent", "reviewer"]

[agents.planner]
enabled = true
program = "codex"
model = "gpt-5.3-codex"
flags = []

[agents.experimental-coder]
enabled = false
program = "codex"
model = "gpt-5.3-codex"
flags = []
```

### Config-to-Internal Mapping

The TOML parser maps config keys to existing internal Go types without renaming them:

- `[agents.*]` -> `Config.Profiles map[string]AgentProfile`
- `[phases]` -> `Config.PhaseRoles map[string]string`

Internal types stay unchanged. New fields added to `AgentProfile`: `Model`, `Temperature`, `Effort`, `Enabled`. These are folded into the `Flags` slice by `BuildCommand()` via the harness adapter at runtime.

State files (`state.json`, `instances.json`) remain JSON -- config is human-edited (TOML), state is machine-managed (JSON).

### Disabled Agent Behavior

If a phase maps to a disabled agent, `ResolveProfile()` treats it the same as a missing profile and falls back to `defaultProgram`. The huh form shows disabled agents but they aren't selectable in the phase mapping stage.

## Harness Adapter Interface

Each supported CLI gets an adapter:

```go
type Harness interface {
    Name() string                                        // "claude", "opencode", "codex"
    Detect() (path string, found bool)                   // is the CLI in PATH?
    ListModels() ([]string, error)                       // available models for huh suggestions
    BuildFlags(agent AgentConfig) []string                // harness-specific CLI flags
    InstallSuperpowers() error                            // global superpowers setup
    ScaffoldProject(dir string, agents []AgentConfig, force bool) error
    SupportsTemperature() bool                            // show temp field in wizard?
    SupportsEffort() bool                                 // show effort field in wizard?
}
```

### claude adapter

- **Detect:** `exec.LookPath("claude")`
- **ListModels:** static `["claude-sonnet-4-6", "claude-opus-4-6", "claude-sonnet-4-5", "claude-haiku-4-5"]`
- **BuildFlags:** `["--model", model, "--effort", effort, ...extra_flags]`
- **InstallSuperpowers:** `claude plugin marketplace add obra/superpowers-marketplace` then `claude plugin install superpowers@superpowers-marketplace`. Checks `claude plugin list` first to skip if already installed.
- **ScaffoldProject:** writes `.claude/agents/*.md`, `.claude/commands/spec-kitty.*.md`
- **SupportsTemperature:** false
- **SupportsEffort:** true

### opencode adapter

- **Detect:** `exec.LookPath("opencode")`
- **ListModels:** shells out to `opencode models`, parses stdout line-by-line (~74 models across anthropic, google, openai, ollama, perplexity, opencode providers)
- **BuildFlags:** returns empty slice; model/temperature/effort go into `opencode.json` project config, not CLI flags
- **InstallSuperpowers:** clone repo to `~/.config/opencode/superpowers`, symlink plugin JS to `~/.config/opencode/plugins/superpowers.js`, symlink skills to `~/.config/opencode/skills/superpowers`
- **ScaffoldProject:** writes `.opencode/agents/*.md`, `.opencode/skills/*/SKILL.md`, updates `opencode.json` with model config
- **SupportsTemperature:** true
- **SupportsEffort:** true (provider-dependent)

### codex adapter

- **Detect:** `exec.LookPath("codex")`
- **ListModels:** returns `["gpt-5.3-codex"]` as default suggestion, accepts free-text input
- **BuildFlags:** `["-m", model, "-c", "reasoning.effort=high", "-c", "temperature=0.3"]`
- **InstallSuperpowers:** clone repo to `~/.codex/superpowers`, symlink to `~/.agents/skills/superpowers`
- **ScaffoldProject:** writes codex-format `AGENTS.md` with agent instructions
- **SupportsTemperature:** true
- **SupportsEffort:** true

## Interactive Flow (huh Stages)

### Stage 1: Harness Detection & Selection

Auto-detect CLIs in PATH. Multi-select with detection status shown:

```
Which agent harnesses do you want to configure?

  [x] claude    (detected: /usr/bin/claude)
  [x] opencode  (detected: /home/kas/.opencode/bin/opencode)
  [ ] codex     (detected: /usr/bin/codex)
```

Pre-checked if detected. Undetected harnesses can still be checked (warning but not blocked).

After confirmation, install superpowers into each selected harness with progress output:

```
Installing superpowers...
  claude   ✓ marketplace added, plugin installed
  opencode ✓ cloned, plugin symlinked, skills symlinked
```

### Stage 2: Agent Configuration

For each agent role (coder, planner, reviewer + option to add custom), a form group:

```
Configure agent: coder

  Harness:      [opencode ▾]      (dropdown: only harnesses selected in stage 1)
  Model:        [anthropic/clau▾]  (filterable list from harness's ListModels())
  Temperature:  [default    ]      (hidden if harness doesn't support it)
  Effort:       [default ▾]        (hidden if harness doesn't support it)
  Enabled:      [yes]
```

Model selection per harness:
- **opencode:** filterable list from `opencode models` runtime output
- **claude:** filterable list from static set `[claude-sonnet-4-6, claude-opus-4-6, claude-sonnet-4-5, claude-haiku-4-5]`
- **codex:** free-text input defaulting to `gpt-5.3-codex`

Temperature and effort fields conditionally shown/hidden based on selected harness's `SupportsTemperature()` / `SupportsEffort()` return values.

### Stage 3: Phase Mapping

```
Map lifecycle phases to agents:

  implementing:    [coder ▾]
  spec_review:     [reviewer ▾]
  quality_review:  [reviewer ▾]
  planning:        [planner ▾]
```

Dropdowns only show enabled agents from stage 2.

### Stage 4: Write & Scaffold

No interaction. Writes everything and prints summary:

```
Writing config...
  ~/.klique/config.toml          ✓

Scaffolding project: /home/kas/dev/klique
  .claude/agents/reviewer.md     ✓
  .opencode/agents/coder.md      ✓
  .opencode/skills/spec-kitty/   ✓

Done! Run 'kq' to start.
```

Only harnesses assigned to at least one enabled agent get project files scaffolded. Existing files skipped unless `--force`.

## Project Scaffolding Details

klique ships embedded canonical agent templates (coder.md, planner.md, reviewer.md) via Go `embed.FS`. The scaffold step translates them into each harness's format.

### claude project layout

```
.claude/
  agents/
    coder.md          # frontmatter: name, description, model, color
    planner.md
    reviewer.md
  commands/
    spec-kitty.*.md   # slash commands from embedded templates
  settings.json       # project-level model prefs if needed
```

### opencode project layout

```
.opencode/
  agents/
    coder.md          # frontmatter: description, mode
    planner.md
    reviewer.md
  skills/
    spec-kitty/SKILL.md
    tui-design/SKILL.md
    tmux-orchestration/SKILL.md
```

### codex project layout

```
.codex/
  AGENTS.md           # single file with all agent instructions
```

Template variables (`{{WP_ID}}`, `{{FEATURE_SLUG}}`) pass through as-is -- resolved at runtime by the harness, not at scaffold time.

## Package Layout

```
internal/init/
  init.go              -- kq init command entry point, orchestrates stages
  harness/
    harness.go         -- Harness interface + Registry
    claude.go          -- claude adapter
    opencode.go        -- opencode adapter
    codex.go           -- codex adapter
  wizard/
    wizard.go          -- huh form stages
  scaffold/
    scaffold.go        -- project-level file writer
    templates/         -- embedded canonical agent/skill templates

config/
  config.go            -- TOML parser added (reads ~/.klique/config.toml)
                       -- maps [agents.*] -> Profiles, [phases] -> PhaseRoles
                       -- internal types unchanged
```

## Dependencies

- `github.com/pelletier/go-toml/v2` or `github.com/BurntSushi/toml` -- TOML parsing
- `github.com/charmbracelet/huh` -- interactive forms (already transitive dep via charm ecosystem)

## What Doesn't Change

- `session/` package -- untouched
- `config/profile.go` -- internal `AgentProfile` struct and `ResolveProfile()` keep field names
- `config/state.go` -- stays JSON
- Task-orchestration worktree -- TOML parser is an additional config source, not a replacement
